---
title: 'Lab 7: Two-Way Within-Subjects ANOVA'
output:
  html_document:
    toc: true
    toc_depth: 3
---

## 1. Introduction

This tutorial will learn how to run two-way within-subjects ANOVA. 

We will use data from your textbook (see ['Support Materials' on the textbook webpage](https://www.routledge.com/Design-and-Analysis-in-Educational-Research-ANOVA-Designs-in-SPSS/Strunk-Mwavita/p/book/9781138361164)) (Vishnumolakala et al. 2018). For your Lab 7 assignment, you will use the data provided on Canvas.

### 1.2 Background

In this study, researchers followed first-year undergraduate chemistry students, measuring their attitudes, self-efficacy, and self-reported experiences both before and after a process-oriented guided inquiry learning intervention (POGIL). The purpose of the intervention was to increase studentsâ€™ attitudes and emotions about chemistry coursework through the POGIL intervention. The authors identified two dependent variables: emotional satisfaction and intellectual accessibility.

**Research Questions**

The authors asked several research questions; in this lab, we will focus on one: 

*To what extent do students attitudes (emotional or intellectual) depend on the POGIL intervention?*

The authors measured both intellectual accessibility and emotional satisfaction using the Attitudes toward the Study of Chemistry Inventory (ASCI). The ASCI is an eight-item scale of seven-point Likert-type items.

## 2. Data Preparation

Remember, we have to restructure the data for within-subjects designs. 

```{r setup, message = FALSE}
needs(tidyverse, rio, here, knitr, kableExtra, misty, janitor, rstatix, psych, misty)
df <- misty::read.sav(here("kamden-mwavita_data/paired samples t-test - Vishnumolakala et al.sav"), use.value.labels = TRUE) %>% 
  clean_names()
```

First, let's view what the data looks like. 
```{r}
head(df)
```

### 2.1 Preparing Variables and Labels

Add in an ID column, if needed.
```{r}
df <- df %>% 
  rowid_to_column("id")
head(df)
```

Next, we need to pivot the data. Now that we have two variables to work with, it would be a good idea to separate the names of each of them via an underscore. So, we rename the variables. I put the **attitude** (intellectual vs. emotional) before the underscore and **intervention** (pre vs. post) after the underscore. 

```{r}
df <- df %>% 
  rename(intellectual_pre = ia_pre,
         intellectual_post = ia_post,
         emotional_pre = es_pre,
         emotional_post = es_post)
```

Check that it worked:
```{r}
head(df)
```

### 2.2 Pivoting the Data from 'Wide' to 'Long'

So, here are the arguments the `pivot_longer` function will take in this case:

* `cols = ` : Since we are pivoting everything except ID, you can choose to write out all the columns (`c(ia_pre, ia_post, es_pre, es_post)`) or you can just write `-id`, which basically takes all the columns except the ID column.
* `names_to = ` : The names are a combination of the attitude and the intervention, so we can write `attitude_intervention`.
* `values_to = ` : These are where the all the scores actually go, so we can call this new column `score`.


This is what it looks like all together:
```{r}
df <- df %>% 
  pivot_longer(cols = -id, 
               names_to = "attitude_intervention",
               values_to = "score")
```

Let's check if it worked:
```{r}
head(df)
```

Now we have one column for student id, one for test score, and one that has both the attitude and intervention. Since these are two separate variables, we need to separate them.

R has a function called `separate()` in the `tidyr` package that can easily do this for you. It takes three arguments:

* `col = ` : this is the column you want to separate. For us, this is `attitude_intervention`.
* `into = c()` : this is what you want to separate the column into. For us, this is `attitude` and `intervention`.
* `sep = ` : this is what you want to separate by (i.e. a space, a hyphen, an underscore). For us, this is an underscore.

Now put it together.
```{r}
df <- df %>% 
  separate(col = attitude_intervention, into = c("attitude", "intervention"), sep = "_")
```

```{r}
head(df)
```

### 2.3 Checking Variable Types

Now, we need to check that each variable is the right data type.
```{r}
str(df)
```

The ID variable, attitude variable, and intervention variable should all be factors. 

There may be a time where you have multiple variables that you are trying to convert into factors. Rather than do each one individually (which can be time consuming if you have many!), you can do it in two lines of code. See below:
```{r}
factor_cols <- c("id", "attitude", "intervention") #list all the columns that should be factors here
df[factor_cols] <- lapply(df[factor_cols], as.factor) #apply the "as.factor" function to all of them
```

```{r}
str(df) #it worked!
```
The function you used above is called `lapply()` that takes a list, applies a function to it, and returns a list. Since a data frame is a type of list, `lapply()` works really well if you are trying to apply a function to multiple columns at once. 

Notice the code is really similar to the previous code you used to convert variables to factors: `df$id <- as.factor(df$id)` On the left of the arrow (assignment operator), you still have the new variable/the variable you are changing. On the right, you have the function and and where you are applying it. 

This function is also a part of the base R functions, which means you don't have to install any special package to access it.

After that, since I only have two levels per variable and there is no order I need them in, I am not using the levels feature that I used in Lab 6. If your variables do have a specific order they need to go in, go back to Lab 6 to see how to re-level the variables in this step.

## 3. Data Exploration and Assumptions

Use the `describe()` and `describeBy()` functions to explore the data.

Let's use boxplots to look at the score distributions.
```{r}
boxplot_attitude <- df %>% 
  ggplot(aes(x = attitude, y = score)) +
  geom_boxplot() +
  coord_flip() + #this rotates the axes, which might make it easier to compare in this case
  theme_minimal() #I like using this theme because it gets rid of the gray background, but you can do any theme or none at all

boxplot_attitude
```

```{r}
boxplots <- df %>% 
  ggplot(aes(x = attitude, y = score)) +
  geom_boxplot(aes(fill = intervention)) + #this groups the boxplots so you can see comparisons across both groups. can also use "group = intervention" if you don't want colors
  coord_flip() +
  theme_minimal() 

boxplots
```

A better way to visually check the normality of data is through a QQ plot. We can use ggplot to help us do this; just plug your dependent variable in next to sample: "`sample = DV`".
```{r}
df %>% 
  ggplot(aes(sample = score)) +
  stat_qq()+
  stat_qq_line(color = "red") +
  theme_classic()
```

Using the visuals and descriptions above, discuss whether ANOVA assumptions are met.

**Important note about Mauchly's Test/Sphericity Assumption:**

Notice that the data set I am using for this tutorial has only two levels per variable. Attitude is either emotional or intellectual and intervention is either pre or post. Therefore, the sphericity assumption does not apply for this dataset.

In the dataset for your lab, one of your variables has three levels. This means that you do need to test the sphericity assumption. In addition, since this is a two-way rather than a one-way, you will need to test the assumption for both the main effect and the interaction. 

What this will look like for you: 
In your ANOVA output below, you will see three sections: Univariate Type III Repeated-Measures ANOVA Assuming Sphericity, Mauchly Tests for Sphericity, and Greenhouse-Geisser and Huynh-Feldt Corrections for Departure from Sphericity.

If p-value > .05 for Mauchly's (meaning your sphericity assumption was violated), you will use the corresponding test statistic from the third section for the main effect/interaction. 

*Let us know if you have any questions about this!*

## 4. Conducting Two-Way Within-Subjects ANOVA

We will still use `aov_car`, part of the `afex` package. We need to specify our ID variable and the independent variables within the `Error()` term.

### 4.1 Creating ANOVA Model

The general structure for two-way within-subjects is as follows:

DV ~ IV1 + IV2 + IV1_IV2_interaction + Error(ID/IV1*IV2)

Plug in the respective values into the model:

```{r}
needs(afex)
m1 <- afex::aov_car(score ~ attitude + intervention + attitude:intervention + Error(id/attitude*intervention),
                           data=df, include_aov = F)
summary(m1)

```

Calculate the effect size (partial eta squared).
```{r}
effectsize::eta_squared(m1)

effectsize::omega_squared(m1)
```

ANOVA results indicated no significant interaction between attitude and intervention. This means that each main effect should be interpreted for its effect on test score. The partial eta squared (pes) of .09 indicates that attitude explains about 9% of the differences in scores, while the pes of .16 indicates that intervention explains 16% of the differences in scores.

### 4.2 Displaying Means

Since we don't see the actual means in the ANOVA output, we can visualize those below, by attitude and by intervention. 
```{r}
means <- df %>% 
  group_by(attitude, intervention) %>% 
  summarise(score = mean(score))
```

```{r}
ggplot(means, aes(x = attitude, y = score, group = intervention)) +
  geom_point() +
  geom_line(aes(color = intervention)) +
  theme_minimal()
```

For all cases, pre-test scores were lower than post-test scores. Intellectual attitudes also had lower scores on average than emotional attitudes. 

## 5. Running Post-Hoc Custom Contrasts

### 5.1 Pairwise Comparisons

First, run `emmeans()` to see the order of the levels, estimates of the differences between the levels, and corresponding p-values and t-statistics.

```{r}
needs(emmeans)
em <- emmeans(m1, ~attitude*intervention)
pairs(em)
```

From here, we can see that emotional and intellectual conditions are significantly different from each other for the pre-test. Also, we can see for both emotional and intellectual, the pre- and post-test scores are different.

### 5.2 Creating Custom Contrasts

Let's say we ask the following research question: To what extent does timing of the test (pre vs. post) on test score depend on the type of test given?

Set up our contrasts below:

```{r}
em #first just look at order of factors to specify coding
contrasts <- list(
  hyp1 = c(1, -1, -1, 1)
)
contrast(em, contrasts)

effectsize::t_to_eta2(
  t = -1.022,
  df_error = 212
)

effectsize::t_to_eta2(
  t = -1.022,
  df_error = 212
)
```

We don't get a significant result here, which makes sense given that the interaction between the two terms was not significant when we ran the ANOVA.

